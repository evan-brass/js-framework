<html lang="en">

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>OAuth Catcher</title>
</head>

<body>
	<p>This page is just to catch the OAuth redirect. It will self close shortly...</p>
	<script type="Application/ECMAScript">
		const channel = new BroadcastChannel('google-auth');

		// Parse the application/x-www-form-urlencoded that comes after the '#'
		const params = new URLSearchParams(window.location.hash.slice(1));

		// Move the parameters onto an object and then broadcast it.
		const ret = {};
		for (const [key, value] of params) {
			ret[key] = value;
		}
		// Handle Errors:
		if (ret.error) {
			ret = new Error(ret.error);
		} else {
			// Convert the expires_in into a timestamp (removing 5sec for safety)
			ret.valid_until = Date.now() + (ret.expires_in - 5) * 1000;
			delete ret.expires_in;
			// Convert the scope property into an array of scopes:
			ret.scopes = ret.scope.split(' ');
			delete ret.scope;
		}

		// Post the message:
		channel.postMessage(ret);


		// TODO: Also store in local storage.
		window.localStorage.setItem('google-token', JSON.stringify(ret));

		// I'm not sure how to get Google to let me use my client id with localhost.  So if we're not running as localhost, then redirect to localhost.
		if (window.location.hostname != 'localhost') {
			window.location.replace('https://localhost/examples/google-calendar/oauth-catch.html' + window.location.hash);
		} else {
			// Close the catch-page.
			window.close();
		}

	</script>
</body>

</html>